# Hot Metal - Task Tracker

## Completed

- [x] **Define SonicJS Collections & Shared Content Types** — Created `posts` and `renditions` collections in `apps/cms-admin`, shared TypeScript types in `packages/content-core`. Replaced sample `blog-posts` collection with full PRD-aligned content model.
- [x] **Build "Looking Ahead" Blog Frontend** — Built Astro 6 frontend with Tailwind v4, SSR on Cloudflare. Pages: Home (hero + post grid), Post detail (with sanitized CMS content), About, Contact. Components: Header with mobile menu, Footer, PostCard, Hero, Illustration SVG. Includes SonicJS API client, view transitions, scroll animations, and full accessibility (ARIA, keyboard nav, focus management).
- [x] **Fix CMS Integration Issues** — Fixed R2 media upload (MEDIA_BUCKET binding), publication creation (SonicJS requires title/slug fields), and API data mapping (SonicJS nests custom fields inside `data` column). Added slug validation and request timeouts to API client.

- [x] **Publisher Service — Phase 1: Core Publishing** — Built the publisher service (`services/publisher`) with Hono on Cloudflare Workers. Includes:
  - CMS custom REST API (`/api/v1/*`) with API key auth and constant-time key comparison
  - Typed CMS API client for cross-service communication
  - Outlet adapter pattern: `BlogAdapter` (publish to blog) and `LinkedInAdapter` (post to LinkedIn)
  - LinkedIn OAuth flow with AES-GCM encrypted token storage in D1
  - LinkedIn content formatter (HTML stripping, 3000-char limit)
  - LinkedIn API client (ugcPosts, text + article shares)
  - Blog publish routes: `POST /publish/blog`, `POST /publish/blog/create`
  - LinkedIn publish route: `POST /publish/linkedin`
  - D1 schema for publisher state (oauth_tokens, oauth_state, audit_logs)
  - Audit logging for all publish actions
  - 25 unit tests (adapters, formatter, CMS API client)

- [x] **Writer Agent — Phase 1: Agentic Drafting & Conversational Editing** — Built the writer agent service (`services/writer-agent`) using Cloudflare Agents SDK + Vercel AI SDK + Hono. Includes:
  - Promoted CMS API client (`CmsApi`, `CmsApiError`) to `@hotmetal/shared` package
  - WriterAgent Durable Object (extends `AIChatAgent`) with per-session SQLite for drafts/research
  - D1-backed session management (CRUD for cross-session metadata)
  - Composable system prompt architecture with style profiles and phase-specific instructions
  - 6 agent tools: `save_draft`, `get_current_draft`, `list_drafts`, `publish_to_cms`, `search_web` (stub), `lookup_source` (stub)
  - REST API: session CRUD, draft retrieval (proxied to agent DO), health check
  - WebSocket endpoint at `/agents/writer-agent/:sessionId` for real-time conversation
  - Writing phase state machine: idle → interviewing → drafting → revising → published
  - API key auth middleware with timing-safe comparison
  - Draft versioning with finalization and intermediate cleanup

- [x] **Writer Agent — Non-Streaming Chat Endpoint** — Added `POST /api/v1/sessions/:id/chat` for synchronous (non-streaming) AI conversation. Uses `generateText` instead of `streamText`, same tools/prompt/state transitions. Includes session existence validation, JSON parse error handling, and extracted shared `prepareLlmCall()` helper to reduce duplication between streaming and non-streaming paths. Updated docs and Postman collection.

- [x] **Writer Web Frontend — Chat-Based Writing Workspace** — Built the writer-web frontend (`apps/web`) as a React SPA with two screens:
  - **Sessions page** (`/`): Session list with create/archive, empty state, loading state, confirmation modals
  - **Workspace page** (`/session/:id`): Two-panel layout with ChatPanel (left) + DraftPanel (right)
  - Resizable divider (drag + keyboard, 30-70% clamp, localStorage persistence)
  - Mobile responsive: stacked layout with tab toggle at < 768px
  - Hot Metal design tokens (amber accent, Inter font, prose styles matching web-frontend)
  - API client for all writer-agent endpoints (sessions CRUD, chat, drafts)
  - Removed `/v1/` prefix from writer-agent routes for simpler proxy
  - Existing component library reused: Button, Card, Modal, Input, Loader, MemoizedMarkdown

- [x] **Writer Web — Streaming Chat & Tool Invocations** — Replaced HTTP non-streaming chat with WebSocket-based streaming using Cloudflare Agents SDK:
  - WebSocket proxy in `server.ts` for `/agents/*` paths (bidirectional message pipe with error handling)
  - `useWriterChat` hook wrapping `useAgent` + `useAgentChat` from agents SDK
  - Streaming text display with real-time token rendering
  - `ToolCallIndicator` component showing agent tool activity (researching, saving draft, etc.) with friendly labels and progress
  - Stop button to cancel in-flight generation
  - Agent state updates trigger draft panel refresh when `currentDraftVersion` changes
  - AI SDK v6 `UIMessage` parts rendering (text, tool invocations)

- [x] **Writer Web — Publish Flow** — End-to-end publishing from the UI. PublishModal with outlet selector (blog/LinkedIn), auto-generated slug, author, tags, excerpt fields. Backend: `/publish` and `/generate-seo` routes on writer-agent, D1 session status update on success. Markdown-to-HTML conversion via `marked` before CMS publish. Slug validation, concurrency guard ('publishing' phase), safe JSON.parse for citations.

- [x] **Writer Web — AI-Generated SEO Fields** — When publish modal opens, calls Claude Haiku to generate SEO excerpt and tags from draft content. Auto-fills form fields with loading states and AI badge indicator. User can edit before publishing.

- [x] **Blog Frontend — Fix Post Routing & Query Filters** — Fixed SonicJS query API: replaced unsupported `filter[field][operator]` syntax with `where` JSON parameter for slug lookup and direct `status` parameter for post listing.

## Upcoming

- [x] **Blog Automation** — Full automation system. See `.agents/plans/blog-automation.md` and `.agents/plans/scout.md` for detailed plans. Phases:
  - [x] Phase 1: Data model & users (D1 migration: users, publications, topics, ideas tables)
  - [x] Phase 2: API endpoints (CRUD for publications, topics, ideas)
  - [x] Phase 8 (partial): Writer-agent updates (publication-aware sessions, seed context, publicationId in publish)
  - [x] Phase 3: Left nav restructure (sidebar layout with Ideas/Writing/Schedule centers)
  - [x] Phase 4: Publication & topics management UI (SchedulePage, PublicationSettingsPage with topics CRUD, auto-publish mode, cadence)
  - [x] Phase 6: Ideas center UI (IdeasPage with filters, IdeaDetailPage with promote/dismiss, shared constants)
  - [x] Phase 5: Content Scout worker (CF Queue + Workflow + KV cache, Alexander API, LLM idea generation, auto-write pipeline)
  - [x] Phase 7: Schedule & auto-publish config (content calendar, manual scout trigger, "Run Scout Now" button, activity timeline)
- [x] **Scout Notification Badge + Polling** — Added Legend State V3 observable store to coordinate scout polling. After "Run Scout Now", polls `GET /api/publications/:pubId/ideas/count` every 10s until new ideas detected (or 3min timeout). Shows notification badge on Ideas nav item. Auto-refreshes IdeasPage when new ideas arrive while user is on that page. Includes cancelled-request safety, accessibility attributes on badge, and publication-aware refresh logic.
- [x] **Fix D1 Concurrent Access Errors** — Root cause: miniflare sets busy_timeout=0 on the shared SQLite file, causing SQLITE_BUSY when writer-agent and content-scout both access D1. Fixed by: (1) replacing batch() with sequential run() per-INSERT to reduce lock duration, (2) adding runWithRetry() utility with exponential backoff (100/200/400ms) for all D1 ops, (3) using deterministic IDs + INSERT OR IGNORE for idempotent workflow retries, (4) fixing content-scout db:migrate:local to use --persist-to flag.
- [x] **Auto-Send Initial Message for Promoted Ideas** — When a session has seedContext (from a promoted idea), auto-sends an initial message to the agent when the chat connects with an empty history. This triggers the agent to review the research context and start drafting immediately.
- [x] **Per-Publication Scout Scheduling** — Each publication now has its own scout schedule (daily at hour H, N times per day, every N days at hour H) with timezone support. DB migration adds `scout_schedule`, `timezone`, `next_scout_at` columns. Shared `computeNextRun()` utility handles DST via `Intl.DateTimeFormat`. Content-scout cron changed from daily to hourly, queries `WHERE next_scout_at <= now()` with optimistic update before enqueue. Frontend settings page has schedule type radio cards, timezone dropdown, hour/count/days pickers, and next-run preview. Manual "Run Scout Now" unaffected.
- [x] **Post Featured Image — AI Generation** — Generate featured images using Cloudflare Workers AI (Flux Schnell). Backend: AI + R2 bindings on writer-agent, D1 migration for `featured_image_url`, 4 endpoints (generate prompt, generate 4 images, select image, serve from R2). Frontend: `ImageGenerator` component with collapsed/prompt/generating/results modes, integrated into DraftPanel. PublishModal shows image preview. Publish flow passes `featuredImageUrl` to CMS. Path-validated R2 serving, session-scoped image URLs, prompt length limits.
- [x] **DAL Service — Phase 0-2: Project Setup, Migrations & Domain Files** — Created `services/data-layer` (`@hotmetal/data-layer`) Cloudflare Worker as the centralized Data Access Layer. D1 migrations 0001-0006 (including publisher tables + multi-user tables). 11 domain files (users, sessions, publications, topics, ideas, activity, audit-logs, oauth-state, social-connections, publication-outlets, publication-tokens) with typed RPC methods via WorkerEntrypoint. AES-GCM token encryption, SHA-256 publication token hashing, INSERT OR IGNORE bulk idempotency. Types exported for consumers.
- [x] DAL Service — Phase 3: Migrate writer-agent to use DAL via Service Binding — Replaced all D1 access (8 route files, WriterAgent DO, publish tool) with `c.env.DAL.*` RPC calls via Service Binding. Removed 5 manager classes and migrations folder. Added `DataLayerApi` interface to data-layer to avoid TS2589. Fixed pre-existing citations type bug.
- [x] DAL Service — Phase 4: Migrate content-scout to use DAL via Service Binding — Replaced all 12 WRITER_DB queries with DAL RPC calls. Removed d1-retry.ts, D1 row types. Updated all snake_case field access to camelCase. Unified IdeaBriefSource with IdeaSource.
- [x] DAL Service — Phase 5: Migrate publisher to use DAL via Service Binding — Replaced all D1 access (audit logs, LinkedIn token store, OAuth state) with DAL RPC calls. Removed LinkedInTokenStore class and AES-GCM encryption (DAL handles internally). Removed TOKEN_ENCRYPTION_KEY from publisher env. Replaced PUBLISHER_DB D1 binding with DAL service binding. Deleted migrations folder. Fixed token store crash safety (create-before-delete) and null personUrn handling.
- [x] DAL Service — Phase 6: Verify & clean up — Confirmed no remaining D1 references in source code across all migrated services (writer-agent, content-scout, publisher). Updated README service bindings tables and "Shared Local D1" section to reflect DAL architecture. Updated writer-agent docs and content-core comment. All 4 services pass typecheck.
- [x] Multi-User — Phase 1: Clerk Auth Integration — Added Clerk JWT authentication to writer-web backend. Includes: clerk-auth middleware (jose JWKS verification, Bearer header + WebSocket query param), ensure-user middleware (fallback user sync with profile updates), ownership verification helpers. Scoped all API routes by authenticated user (sessions, publications, ideas, topics, activity, scout). Frontend: AuthProvider with ClerkProvider + token sync, useWriterChat sends auth token for WebSocket. Removed hardcoded DEFAULT_USER_ID. Stripped Authorization header from downstream proxy. Updated DAL: INSERT OR IGNORE for users, userId filter on getRecentActivity.
- [x] Multi-User — Phase 2: Frontend Auth UI — Added public/protected route split with Clerk UI components. Public routes: landing page (/), sign-in (/sign-in), sign-up (/sign-up), waitlist (/waitlist). Protected routes wrapped with ProtectedRoute (TokenSync + loading gate). AuthProvider refactored to ClerkProvider-only with reactive dark mode appearance (useSyncExternalStore + MutationObserver). Landing page with hero, feature cards, and CTAs (redirects signed-in users to /writing). UserButton in sidebar for account management. Installed @clerk/themes for amber-themed Clerk components.
- [x] Multi-User — Phase 3: Data Migration — Replaced runtime default-user migration with dev-time Clerk seed script. Removed `migrateDefaultUser()` from DAL, simplified `ensureUser` middleware (create on first login, update on profile change). Added `scripts/seed-dev-user.sh` that reads `CLERK_SECRET_KEY` from root `.dev.vars`, fetches the first Clerk user, and seeds them into local D1 via wrangler. Added `dal:seed:dev` and updated `dal:reset:local` to include seeding. Cleaned up migration files (removed hardcoded INSERT of 'default' user from both data-layer and content-scout).
- [x] **Writing Styles Feature** — Full writing styles system for customizable AI writer voice. Includes:
  - D1 migration (`0007_writing_styles.sql`): `writing_styles` table + `style_id` FK on publications & sessions, 2 seeded prebuilt styles (Conversational Expert, Professional Analyst)
  - Data layer: `writing-styles.ts` domain (CRUD + list by user/prebuilt), `styleId` added to Session/Publication types & domains
  - Alexander API: `toneGuide()` method in `@hotmetal/shared` (120s timeout, POST `/writing/tone-guide`)
  - Writer-web backend: `/api/styles` routes (CRUD, analyze-url with SSRF protection, duplicate), Alexander env config
  - Frontend: StylesPage (prebuilt + user sections), StyleCard component, StyleFormModal (manual prompt + URL analysis with loading messages), Sidebar nav entry, route at `/styles`
  - Publication settings: Writing Style dropdown with "Manage Styles" link
  - Session creation: accepts `styleId`, "Use" button on style cards creates session + navigates to workspace
  - Writer-agent integration: `styleId` in agent state, async `prepareLlmCall()` with style cascade (session > publication > default), `customStylePrompt` option in system prompt builder
- [x] **Publication Home Page** — Added `/publications/:id` home page showing published posts, latest ideas, and settings link. Moved existing settings page to `/publications/:id/settings`. Added `publicationId` filter to DAL `listSessions`, new `GET /publications/:pubId/sessions` API route, `fetchSessionsByPublication` frontend helper. Extracted `formatRelativeTime` to shared `lib/format.ts` utility (deduplicated from 4 files).
- [x] **RSS/Atom Feeds** — Pre-generated RSS 2.0 and Atom feeds per publication, stored in KV, served from publisher service. Two feed variants (full content, partial/excerpt) controlled by per-publication settings. Includes:
  - DB migration (`0008_feed_settings.sql`): `feed_full_enabled` and `feed_partial_enabled` columns on publications
  - Data layer: `getPublicationBySlug()`, feed columns in mapRow/create/update
  - CMS API: `publicationId` filter added to `GET /posts` and `CmsApi.listPosts`
  - Publisher: KV `FEEDS` binding, `feed-generator.ts` (hand-built XML with escapeXml), `feed-store.ts` (KV read/write with SHA-256 ETag + conditional requests), `feeds.ts` routes with slug validation
  - Public feed URLs: `/:slug/rss`, `/:slug/rss/full`, `/:slug/atom`, `/:slug/atom/full`
  - Internal regeneration: `POST /internal/feeds/regenerate/:slug` (API key auth)
  - Web app: PUBLISHER service binding, fire-and-forget feed regeneration after publish (waitUntil), RSS Feeds settings section in publication page with enable/disable checkboxes and feed URL display
- [x] **Multi-User LinkedIn Connections & Settings Page** — Thread userId through publisher OAuth and publish flows, add web app connections API, build Settings page with LinkedIn connection management, and enable LinkedIn in PublishModal. Includes:
  - DB migration (`0009_oauth_state_user_id.sql`): `user_id` column on `oauth_state` table
  - Data layer: `OAuthStateResult` type, updated `storeOAuthState`/`validateAndConsumeOAuthState` for userId
  - Publisher: removed `DEFAULT_USER_ID`, thread userId through token-store, OAuth routes (with API key auth), publish route
  - Publisher: `WEB_APP_URL` env var for OAuth callback redirects back to web app
  - Web app: `/api/connections` routes (list, delete, OAuth initiate, status check) with ownership verification
  - Frontend: `SocialConnection` type, connection API functions, Settings page (`/settings`) with LinkedIn connect/disconnect
  - PublishModal: LinkedIn toggle checkbox, `publishToLinkedIn` flag, fire-and-forget LinkedIn publish via `waitUntil`
  - Sidebar: Settings nav item with gear icon
- [x] **Web Landing Page + Public FAQ Page** — Updated the web landing page to better sell "consistent content → authority" (new hero, workflow flow, expanded feature grid, audiences, improved readability, links) and added a public `/faq` page with comprehensive product FAQs, linked from the landing footer.
- [x] **X (Twitter) Integration** — Full Twitter/X social publishing support, mirroring the existing LinkedIn pattern. Includes:
  - DB migration (`0010_oauth_state_metadata.sql`): `metadata` column on `oauth_state` for PKCE code_verifier storage
  - Data layer: metadata param in `storeOAuthState`/`validateAndConsumeOAuthState`
  - Content-core: added `'twitter'` to OUTLETS array
  - Publisher Twitter module: OAuth 2.0 with PKCE (`oauth.ts`), Twitter v2 API client (`api.ts`), tweet formatter with t.co length accounting (`formatter.ts`), token store with auto-refresh (`token-store.ts`), admin notification placeholder (`notify.ts`)
  - Publisher `TwitterAdapter`: OutletAdapter implementation (prepareRendition, validate 280-char limit, publish via v2 API)
  - Publisher routes: 3 OAuth routes (initiate, callback, status) + `POST /publish/twitter` with optional custom tweet text
  - Publisher env: `TWITTER_CLIENT_ID`, `TWITTER_CLIENT_SECRET`, `TWITTER_REDIRECT_URI`
  - Web app backend: Twitter OAuth proxy routes, Twitter fire-and-forget publish via `waitUntil`, server-side tweet length validation
  - Frontend Settings page: X connection card with connect/disconnect, per-provider connecting state
  - Frontend PublishModal: X checkbox, editable tweet text editor with char counter (280 max, t.co-aware), auto-generate from AI hook, publish disabled on over-limit, success message
- [x] **PublishModal UI Redesign + AI Tweet Generation** — Full PublishModal restructure with fixed header/footer, scrollable body (max-h-[60vh]), blog details section, and collapsible social cards (X + LinkedIn) with CSS grid animation. AI tweet generation via new `/generate-tweet` endpoint using Claude Haiku 4.5 (leaves room for t.co 23-char link). Collapsible cards auto-expand on toggle, show collapsed summary when minimized. LinkedIn card shows placeholder for future customization. Character counter accounts for appended link. Race condition fix: re-triggers tweet generation when SEO hook arrives if X is already selected.
- [x] **Publications Frontend (Phases 0-6)** — Built multi-tenant Astro 6 blog frontend (`apps/publications-web`) serving each publication at `{slug}.hotmetalapp.com`. Includes:
  - D1 migration (`0011_publication_branding.sql`): 8 new columns for branding/template support (template_id, tagline, logo_url, header_image_url, accent_color, social_links, custom_domain, meta_description)
  - Data layer: SocialLinks interface, updated Publication type + mapRow/create/update with all new fields
  - Multi-tenant resolution: subdomain extraction from `*.hotmetalapp.com` with dev-only header/env fallback
  - Starter template: BaseLayout (Inter font, OG/Twitter/JSON-LD meta), Header (sticky, mobile menu), PublicationHero (optional bg image), PostCard, PostList (responsive grid), Footer (social icons, "Powered by Hot Metal")
  - Pages: Home (post grid), Post detail (sanitized content, citations, tags, share links), 404, RSS 2.0, Atom, sitemap.xml, robots.txt
  - Cache: `s-maxage=3600, stale-while-revalidate=86400` on all pages, cache-purge endpoint with timing-safe API key auth
  - Security: social link URL validation (https only), accentColor hex validation, slug validation on all inputs, dev-header gated behind localhost
  - Cloudflare Workers: `import { env } from 'cloudflare:workers'` (Astro v6 pattern), DAL service binding, wildcard route
- [x] **Image URL Fix** — Fixed double `/images/` path prefix in R2 keys and absolute localhost URLs stored in CMS. R2 keys now use `sessions/{sessionId}/{id}.png`. Production uses `IMAGE_BASE_URL` (R2 custom domain `images.hotmetalapp.com`), dev uses relative paths. Added image proxy route to publications-web (`/api/images/[...path]`) for dev. Added `decodeURIComponent` path traversal protection and strict `startsWith` URL validation on select-image endpoint.
- [x] **Dev Stack for Publications Frontend** — Added `dev:stack-pub` command and `@cloudflare/vite-plugin` integration in `astro.config.mjs` for running publications-web with auxiliary workers (DAL, content-scout, publisher) using shared persistent state.
- [x] **Fix Social Sharing URLs + Link Picker** — Fixed three bugs in social sharing: (1) URLs pointed to CMS instead of publication frontend — now resolve dynamically via `resolvePublicationBaseUrl` using publication slug/customDomain, (2) Twitter custom tweet text lost the blog URL — now appends URL to user's text, (3) multi-publication ambiguity — added "Link to share" radio picker in PublishModal when 2+ publications selected + social enabled. Added `PUBLICATIONS_BASE_DOMAIN` env var, `socialPublicationId` param through the full stack, server-side ownership validation, URL preview in modal. Fixed `/posts/` prefix in all adapter URLs (correct path is `/{slug}`).
- [x] **LinkedIn Publish UX** — Full LinkedIn post customization in PublishModal. Two post modes: Link Post (short commentary + article preview card) and Text Post (full body as standalone LinkedIn post). Editable textarea with character counter (3000 limit), "Optimize for LinkedIn" AI button using Claude Haiku (user-triggered only to save costs). Reusable `optimizeForLinkedIn` writing utility with link/text mode prompts. Backend: writer-agent endpoint, API proxy, publisher custom text override (mirrors Twitter pattern). Frontend: post type toggle, default text population (hook for link, draft body for text), AI badge indicator.
- [x] **Publication Templates — Editorial & Bold** — Added two new publication templates alongside the existing starter template. Includes:
  - Template switching architecture: Page-level switcher components (HomePage, PostPage, NotFoundPage) with static imports + conditional rendering by templateId
  - Shared HeadMeta.astro: Extracted SEO/OG/Twitter/JSON-LD meta tags into a reusable fragment used by all template BaseLayouts
  - Extracted per-template PostContent.astro components from inline [slug].astro markup
  - Editorial template: Magazine/literary style with Playfair Display + Source Serif 4 fonts, off-white bg (#faf8f5), burgundy accent (#8b2635), centered masthead, featured post layout, 3-column grid, horizontal "More Stories" section, drop cap on post pages, pull quote styling
  - Bold template: Tech/design-forward style with Space Grotesk + JetBrains Mono fonts, blue accent (#2563eb), 3px black borders, split hero with featured post, numbered post list, topic filter chips, 4-column explore grid, dark footer, reading progress bar, sidebar TOC (server-side heading extraction), dark callout boxes
  - CSS isolation: Identical custom property names across templates with different values; only one template's theme.css loads per SSR request
  - Template registry updated with editorial and bold entries
- [x] **Rich Text Draft Editing with Tiptap** — Added Tiptap WYSIWYG editor to the DraftPanel with view/edit toggle. Includes:
  - Backend: `updateDraft()` method on WriterAgent DO (overwrites current draft in-place), PUT /drafts HTTP route, API proxy, frontend API function
  - TiptapEditor component: StarterKit + tiptap-markdown extension for Markdown round-tripping, BubbleMenu for inline formatting (bold/italic/code/strikethrough), placeholder extension
  - DraftPanel integration: view/edit toggle (PencilSimple/Eye icons), edit-only on latest version, auto-save with 2s debounce, save status indicator (Saving.../Saved/Unsaved), flush-on-mode-switch
  - Agent conflict handling: when agent creates new draft version while user is editing, pending edits are flushed and edit mode exits to show the new AI draft
  - No pipeline changes needed: agent's `getCurrentDraft()` reads from same SQLite, so user edits are visible to AI automatically
- [x] **Publication Setup Wizard** — Replaced the simple 3-field `CreatePublicationModal` with a 5-step guided wizard for new publication creation. Includes:
  - Legend State V3 observable store (`wizard-store.ts`) with async step handlers and saving guards
  - Step 1 (Basics): Name, Slug (auto-derived), Description — creates publication on Next
  - Step 2 (Topics): Inline topic creator with removable cards, batch create with `Promise.allSettled`, stable localId keys, duplicate-save prevention via serverId tracking
  - Step 3 (Writing Style): Lazy-loaded prebuilt styles as radio cards, retry UI on load failure
  - Step 4 (Publish Mode): Draft vs Auto Publish radio cards with clear explanations and "Recommended" badge, conditional posts-per-week input
  - Step 5 (All Set): Configuration summary + two CTAs ("Run Content Scout" with scout polling, "Start Writing" with session creation)
  - Progress bar with aria-label, Back/Skip/Next footer navigation
  - Orphaned publication handling: notifies parent on mid-wizard close so the list refreshes
  - Wired up in DashboardPage and PublicationsPage, old CreatePublicationModal deleted
- [x] **Getting Started Checklist** — Persistent dashboard checklist guiding new users through 6 onboarding steps (create publication → add topics → run ideas agent → review idea → write first post → publish). Includes:
  - `checklist-store.ts`: Legend State V3 observable with `syncObservable` + `ObservablePersistLocalStorage` for persistent collapsed/dismissed state
  - `GettingStartedChecklist.tsx`: Self-contained component with 4 parallel API fetches, declarative step definitions with completion checks and conditional actions (links + handlers), progress bar, collapse/expand, per-publication dismiss
  - Multi-publication support: accepts `publications[]` array, finds first undismissed pub (most recent first)
  - Inline actions: "Run now" triggers scout + polling, "Start writing" creates session + navigates
  - Step prerequisites: actions gated on prior step completion (e.g., write requires reviewed idea)
  - Silent error handling: hides checklist on fetch failure, no dashboard blocking
  - Integrated into DashboardPage between greeting and publications section
- [x] **Dashboard Quick Actions** — Quick action shortcuts that replace the checklist after dismissal. Includes:
  - Extracted `NewSessionModal` from `SessionsPage` into reusable `components/session/NewSessionModal.tsx`
  - `QuickActions` component with 3 card-style CTAs: Start Writing (opens NewSessionModal), Get New Ideas (triggers scout, pub picker if >1), Create Writing Style (link to /styles, conditional on no custom styles)
  - Dashboard integration: fetches styles on load, reads `checklistStore$.dismissed`, conditionally renders checklist vs quick actions in same slot
  - Dynamic grid layout: 3-col when style card shows, 2-col when hidden
- [x] **Structured Writing Styles + LLM-Composed Final Prompt** — Refactored writing styles system to store structured tone guide fields as proper DB columns and use LLM composition for the writer agent prompt. Includes:
  - D1 migration (`0012_writing_styles_structured.sql`): 21 new nullable columns (finalPrompt, voice_*, sentence_*, structure_*, vocabulary_*, rhetoricalDevices, content_*, dos, donts) with backfill
  - DAL: `parseJsonArray`/`jsonOrNull` helpers, `FIELD_TO_COLUMN` map for dynamic update builder, expanded `WritingStyleRow` mapping
  - `compose-style-prompt.ts`: Claude Haiku synthesizes structured fields into 300-600 word `finalPrompt` at style creation time (not on every agent call)
  - Backend API: `POST /styles` and `PATCH /styles/:id` accept structured fields, compose `finalPrompt` via LLM; `hasStructuredFields` check with full field coverage; `mergedFields` fallback on edit
  - Frontend: `StyleFormModal` extracts structured fields from Alexander URL analysis, passes through `StyleSaveData`; `StylesPage` passes all fields to API
  - Writer agent: `resolveCustomStyle()` uses `style.finalPrompt ?? style.systemPrompt` (backward compatible)
  - Alexander API types updated to match actual snake_case response with all optional nested objects
- [x] **Ideas Ordering Fix** — Fixed ideas filtered by publication not returning in `created_at DESC` order. Removed `relevance_score DESC` from ORDER BY clause in `listIdeasByPublication` (nullable column caused mixed ordering).
- [x] **Admin Endpoint: Create Prebuilt Style from URL** — Added `POST /admin/styles/from-url` endpoint for creating built-in writing styles via Alexander URL analysis. Includes:
  - DAL refactor: `CreateWritingStyleInput` now accepts optional `isPrebuilt` flag and optional `userId` (instead of hardcoded `is_prebuilt = 0`)
  - Shared `lib/tone-guide.ts`: Extracted `ToneGuideFields` interface, `hasStructuredFields()`, and `extractToneGuideFields()` — used by admin endpoint, API routes, and frontend modal (deduplicated from 2 places)
  - `StyleSaveData` now extends `ToneGuideFields` instead of redeclaring all fields
  - `adminAuth` middleware: validates X-Internal-Key only (no X-User-Id required, unlike internalAuth)
  - Admin route calls Alexander → extracts structured fields → composes finalPrompt via LLM → creates prebuilt style
- [ ] Writer Agent — Phase 2: Voice input (transcription in `input-processor.ts`)
- [ ] Writer Agent — Phase 2: D1 session sync (synchronize DO state back to D1 for listing accuracy)
