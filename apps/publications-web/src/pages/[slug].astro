---
import { env } from 'cloudflare:workers';
import { resolvePublication } from '../lib/resolve-publication';
import { getPublicationBranding } from '../dl/publication';
import { getPostBySlug } from '../dl/posts';
import { sanitizeCmsContent } from '../lib/sanitize';
import { formatDate } from '../lib/format';
import PostPage from '../components/PostPage.astro';

const publication = await resolvePublication(Astro.request, env.DAL, env.DEV_PUBLICATION_SLUG);

if (!publication) {
  return new Response(null, { status: 404, statusText: 'Publication Not Found' });
}

if (!publication.cmsPublicationId) {
  return new Response(null, { status: 404, statusText: 'Publication not configured' });
}

const { slug } = Astro.params;

if (!slug) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const post = await getPostBySlug(env, slug, publication.cmsPublicationId);

if (!post) {
  return new Response(null, { status: 404, statusText: 'Post Not Found' });
}

const branding = getPublicationBranding(publication);
const sanitizedContent = sanitizeCmsContent(post.content);
const date = post.publishedAt ? formatDate(post.publishedAt) : null;

const tags = post.tags
  ? post.tags.split(',').map((t) => t.trim()).filter(Boolean)
  : [];

const topics = post.topics
  ? post.topics.split(',').map((t) => t.trim()).filter(Boolean)
  : [];

const allLabels = [...topics, ...tags];

const title = post.seoTitle ?? post.title;
const description = post.seoDescription ?? post.excerpt ?? post.hook ?? '';
const ogImage = post.ogImage ?? post.featuredImage;
const canonicalUrl = post.canonicalUrl ?? `https://${publication.slug}.hotmetalapp.com/${post.slug}`;
const postUrl = `https://${publication.slug}.hotmetalapp.com/${post.slug}`;

Astro.response.headers.set('Cache-Control', 'public, s-maxage=3600, stale-while-revalidate=86400');

const jsonLd: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.title,
  author: {
    '@type': 'Person',
    name: post.author,
  },
  datePublished: post.publishedAt ?? post.createdAt,
  dateModified: post.updatedAt,
  url: postUrl,
  ...(ogImage ? { image: ogImage } : {}),
  ...(description ? { description } : {}),
  publisher: {
    '@type': 'Organization',
    name: branding.name,
    ...(branding.logoUrl ? { logo: { '@type': 'ImageObject', url: branding.logoUrl } } : {}),
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': postUrl,
  },
};

const encodedTitle = encodeURIComponent(post.title);
const encodedUrl = encodeURIComponent(postUrl);
const twitterShareUrl = `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`;
const linkedinShareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;
---

<PostPage
  templateId={branding.templateId}
  {branding}
  {post}
  {sanitizedContent}
  {date}
  {allLabels}
  {postUrl}
  {twitterShareUrl}
  {linkedinShareUrl}
  {title}
  {description}
  {ogImage}
  {canonicalUrl}
  ogType="article"
  {jsonLd}
  rssUrl={`https://${publication.slug}.hotmetalapp.com/rss`}
  articlePublishedTime={post.publishedAt}
  articleModifiedTime={post.updatedAt}
  articleAuthor={post.author}
  articleTags={allLabels.length > 0 ? allLabels : undefined}
/>
