---
import { env } from 'cloudflare:workers';
import { resolvePublication } from '../lib/resolve-publication';
import { getPublicationBranding } from '../dl/publication';
import { getPostBySlug } from '../dl/posts';
import { sanitizeCmsContent } from '../lib/sanitize';
import { formatDate } from '../lib/format';
import BaseLayout from '../templates/starter/layouts/BaseLayout.astro';
import Header from '../templates/starter/components/Header.astro';
import Footer from '../templates/starter/components/Footer.astro';

const publication = await resolvePublication(Astro.request, env.DAL, env.DEV_PUBLICATION_SLUG);

if (!publication) {
  return new Response(null, { status: 404, statusText: 'Publication Not Found' });
}

if (!publication.cmsPublicationId) {
  return new Response(null, { status: 404, statusText: 'Publication not configured' });
}

const { slug } = Astro.params;

if (!slug) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const post = await getPostBySlug(env, slug, publication.cmsPublicationId);

if (!post) {
  return new Response(null, { status: 404, statusText: 'Post Not Found' });
}

const branding = getPublicationBranding(publication);
const sanitizedContent = sanitizeCmsContent(post.content);
const date = post.publishedAt ? formatDate(post.publishedAt) : null;

const tags = post.tags
  ? post.tags.split(',').map((t) => t.trim()).filter(Boolean)
  : [];

const topics = post.topics
  ? post.topics.split(',').map((t) => t.trim()).filter(Boolean)
  : [];

const allLabels = [...topics, ...tags];

const title = post.seoTitle ?? post.title;
const description = post.seoDescription ?? post.excerpt ?? post.hook ?? '';
const ogImage = post.ogImage ?? post.featuredImage;
const canonicalUrl = post.canonicalUrl ?? `https://${publication.slug}.hotmetalapp.com/${post.slug}`;
const postUrl = `https://${publication.slug}.hotmetalapp.com/${post.slug}`;

Astro.response.headers.set('Cache-Control', 'public, s-maxage=3600, stale-while-revalidate=86400');

const jsonLd: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.title,
  author: {
    '@type': 'Person',
    name: post.author,
  },
  datePublished: post.publishedAt ?? post.createdAt,
  dateModified: post.updatedAt,
  url: postUrl,
  ...(ogImage ? { image: ogImage } : {}),
  ...(description ? { description } : {}),
  publisher: {
    '@type': 'Organization',
    name: branding.name,
    ...(branding.logoUrl ? { logo: { '@type': 'ImageObject', url: branding.logoUrl } } : {}),
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': postUrl,
  },
};

const encodedTitle = encodeURIComponent(post.title);
const encodedUrl = encodeURIComponent(postUrl);
const twitterShareUrl = `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`;
const linkedinShareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`;
---

<BaseLayout
  title={title}
  publicationName={branding.name}
  description={description}
  ogImage={ogImage}
  canonicalUrl={canonicalUrl}
  accentColor={branding.accentColor}
  ogType="article"
  jsonLd={jsonLd}
  rssUrl={`https://${publication.slug}.hotmetalapp.com/rss`}
>
  <Header publicationName={branding.name} logoUrl={branding.logoUrl} />

  <article class="py-12 md:py-20">
    {/* Featured image */}
    {post.featuredImage && (
      <div class="mx-auto max-w-[var(--max-width-wide)] px-6 mb-10">
        <img
          src={post.featuredImage}
          alt={post.title}
          class="w-full rounded-xl object-cover max-h-[480px]"
        />
      </div>
    )}

    {/* Header */}
    <header class="mx-auto max-w-[var(--max-width-prose)] px-6 mb-12">
      <h1 class="text-4xl md:text-5xl font-black tracking-tight leading-[1.15] mb-4">
        {post.title}
      </h1>

      {post.subtitle && (
        <p class="text-xl text-text-muted leading-relaxed mb-6">
          {post.subtitle}
        </p>
      )}

      <div class="flex items-center gap-3 text-sm text-text-muted">
        <span class="font-medium text-text">{post.author}</span>
        {date && post.publishedAt && (
          <>
            <span aria-hidden="true">&middot;</span>
            <time datetime={post.publishedAt}>{date}</time>
          </>
        )}
      </div>
    </header>

    {/* Content */}
    <div
      class="prose mx-auto max-w-[var(--max-width-prose)] px-6"
      set:html={sanitizedContent}
    />

    {/* Citations */}
    {post.citations && post.citations.length > 0 && (
      <aside class="mx-auto max-w-[var(--max-width-prose)] px-6 mt-16">
        <h2 class="text-lg font-bold mb-4">Sources & Citations</h2>
        <ol class="list-decimal list-inside space-y-3 text-sm text-text-muted">
          {post.citations.map((citation) => (
            <li>
              <a
                href={citation.url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-accent hover:text-accent-hover underline underline-offset-2"
              >
                {citation.title}
              </a>
              {citation.publisher && (
                <span> &mdash; {citation.publisher}</span>
              )}
            </li>
          ))}
        </ol>
      </aside>
    )}

    {/* Tags / Topics */}
    {allLabels.length > 0 && (
      <div class="mx-auto max-w-[var(--max-width-prose)] px-6 mt-12">
        <div class="flex flex-wrap gap-2">
          {allLabels.map((label) => (
            <span class="px-3 py-1 text-xs font-medium rounded-full bg-bg-card text-text-muted">
              {label}
            </span>
          ))}
        </div>
      </div>
    )}

    {/* Share links */}
    <div class="mx-auto max-w-[var(--max-width-prose)] px-6 mt-12 pt-8 border-t border-border">
      <p class="text-sm font-medium text-text-muted mb-4">Share this article</p>
      <div class="flex items-center gap-4">
        {/* Twitter / X */}
        <a
          href={twitterShareUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-bg-card text-text hover:bg-border transition-colors"
          aria-label="Share on Twitter"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
          </svg>
          <span>Twitter</span>
        </a>

        {/* LinkedIn */}
        <a
          href={linkedinShareUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-bg-card text-text hover:bg-border transition-colors"
          aria-label="Share on LinkedIn"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
          </svg>
          <span>LinkedIn</span>
        </a>

        {/* Copy link */}
        <button
          id="copy-link-btn"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-bg-card text-text hover:bg-border transition-colors cursor-pointer"
          aria-label="Copy link to clipboard"
          data-url={postUrl}
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
          <span>Copy link</span>
        </button>
      </div>
    </div>
  </article>

  <Footer
    publicationName={branding.name}
    publicationSlug={branding.slug}
    socialLinks={branding.socialLinks}
  />
</BaseLayout>

<script>
  function initCopyLink() {
    const btn = document.getElementById('copy-link-btn');
    if (!btn) return;

    btn.addEventListener('click', async () => {
      const url = btn.getAttribute('data-url');
      if (!url) return;

      try {
        await navigator.clipboard.writeText(url);
        const label = btn.querySelector('span');
        if (label) {
          const original = label.textContent;
          label.textContent = 'Copied!';
          setTimeout(() => {
            label.textContent = original;
          }, 2000);
        }
      } catch {
        // Fallback: do nothing if clipboard API is unavailable
      }
    });
  }

  initCopyLink();
  document.addEventListener('astro:after-swap', initCopyLink);
</script>
