---
import { env } from 'cloudflare:workers';
import { resolvePublication } from '../lib/resolve-publication';
import { getPublicationBranding } from '../dl/publication';
import { listPublishedPosts } from '../dl/posts';
import HomePage from '../components/HomePage.astro';

const publication = await resolvePublication(Astro.request, env.DAL, env.DEV_PUBLICATION_SLUG);

if (!publication) {
  return new Response(null, { status: 404, statusText: 'Publication Not Found' });
}

const branding = getPublicationBranding(publication);
const posts = publication.cmsPublicationId
  ? await listPublishedPosts(env, publication.cmsPublicationId)
  : [];
const baseUrl = `https://${publication.slug}.hotmetalapp.com`;

Astro.response.headers.set('Cache-Control', 'public, s-maxage=3600, stale-while-revalidate=86400');

const jsonLd: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: branding.name,
  url: baseUrl,
  description: branding.metaDescription ?? branding.tagline ?? `${branding.name} publication`,
  publisher: {
    '@type': 'Organization',
    name: branding.name,
    ...(branding.logoUrl ? { logo: { '@type': 'ImageObject', url: branding.logoUrl } } : {}),
  },
};
---

<HomePage
  templateId={branding.templateId}
  {branding}
  {posts}
  {baseUrl}
  {jsonLd}
/>
