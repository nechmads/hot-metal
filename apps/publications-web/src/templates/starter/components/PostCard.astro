---
import type { Post } from '@hotmetal/content-core';
import { formatDate } from '../../../lib/format';

interface Props {
  post: Post;
}

const { post } = Astro.props;

const date = post.publishedAt ? formatDate(post.publishedAt) : null;

const PREVIEW_LENGTH = 180;

function getPreviewText(post: Post): string | null {
  if (post.hook) return post.hook;
  if (post.excerpt) return post.excerpt;
  if (!post.content) return null;
  const plain = post.content.replace(/<[^>]*>/g, '').trim();
  if (!plain) return null;
  if (plain.length <= PREVIEW_LENGTH) return plain;
  return plain.slice(0, PREVIEW_LENGTH).trimEnd() + '...';
}

const preview = getPreviewText(post);

const tags = post.tags
  ? post.tags.split(',').map((t) => t.trim()).filter(Boolean)
  : [];
---

<article class="animate-on-scroll group">
  <a href={`/${post.slug}`} class="block">
    {post.featuredImage && (
      <div class="aspect-[16/10] overflow-hidden rounded-lg mb-4 bg-bg-card">
        <img
          src={post.featuredImage}
          alt={post.title}
          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
          loading="lazy"
        />
      </div>
    )}

    <div class="space-y-2">
      <div class="flex items-center gap-2 text-sm text-text-muted">
        {date && post.publishedAt && (
          <time datetime={post.publishedAt}>{date}</time>
        )}
        {date && post.author && <span aria-hidden="true">&middot;</span>}
        {post.author && <span>{post.author}</span>}
      </div>

      <h2 class="text-xl font-bold leading-snug group-hover:text-accent transition-colors">
        {post.title}
      </h2>

      {preview && (
        <p class="text-text-muted leading-relaxed line-clamp-3">
          {preview}
        </p>
      )}

      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2 pt-1">
          {tags.map((tag) => (
            <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-bg-card text-text-muted">
              {tag}
            </span>
          ))}
        </div>
      )}
    </div>
  </a>
</article>
