{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "hotmetal-web",
  "main": "src/server.ts",
  "compatibility_date": "2026-02-05",
  "compatibility_flags": ["nodejs_compat"],
  "observability": {
    "enabled": true,
  },

  "dev": {
    "port": 5173,
  },

  // Durable Objects — one WriterAgent instance per writing session
  "durable_objects": {
    "bindings": [
      {
        "name": "WRITER_AGENT",
        "class_name": "WriterAgent",
      },
    ],
  },

  // SQLite migrations for agent-local state (drafts, research_notes)
  "migrations": [
    {
      "tag": "v1",
      "new_sqlite_classes": ["WriterAgent"],
    },
  ],

  // Service bindings
  "services": [
    {
      "binding": "DAL",
      "service": "hotmetal-data-layer",
      "entrypoint": "DataLayer",
    },
    {
      "binding": "CONTENT_SCOUT",
      "service": "hotmetal-content-scout",
    },
    {
      "binding": "PUBLISHER",
      "service": "hotmetal-publisher",
    },
  ],

  // Workers AI binding (for image generation)
  "ai": { "binding": "AI" },

  // R2 bucket for generated images
  "r2_buckets": [
    {
      "binding": "IMAGE_BUCKET",
      "bucket_name": "hotmetal-cms-bucket",
    },
  ],

  // Environment variables (non-secret)
  "vars": {
    "CMS_URL": "https://cms.hotmetalapp.com",
    "CONTENT_SCOUT_URL": "https://scout.hotmetalapp.com",
    "ALEXANDER_API_URL": "https://alexanderai.farfarawaylabs.com",
    "CLERK_PUBLISHABLE_KEY": "pk_live_Y2xlcmsuaG90bWV0YWxhcHAuY29tJA",
    "CLERK_ISSUER": "https://clerk.hotmetalapp.com",
  },

  // SPA fallback — serve index.html for unmatched routes (client-side routing)
  // run_worker_first sends only matching paths to the Worker; everything else
  // is served from the static asset pipeline (or falls back to index.html).
  "assets": {
    "not_found_handling": "single-page-application",
    "run_worker_first": ["/api/*", "/agents/*", "/health", "/internal/*"],
  },

  // Secrets (set via `wrangler secret put`):
  // ANTHROPIC_API_KEY    — Claude API key for AI drafting, SEO, hooks
  // CMS_API_KEY          — authenticates requests to the CMS
  // SCOUT_API_KEY        — authenticates requests to content-scout
  // ALEXANDER_API_KEY    — authenticates requests to Alexander research API
  // PUBLISHER_API_KEY    — authenticates requests to the publisher service
  // INTERNAL_API_KEY     — service-to-service auth (content-scout auto-write)
}
